<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜åå°</title>
  <link rel="stylesheet" href="common.css">
  <style>
    /* æç®€æ ¸å¿ƒæ ·å¼ - åŠ è½½å¿«ã€å¸ƒå±€ç¨³ */
    .admin-box { display: grid; grid-template-columns: 200px 1fr; gap: 20px; padding: 20px; min-height: 80vh; }
    .left-menu { background: #2c3e50; border-radius: 8px; padding: 20px; }
    .left-menu h3 { color: white; margin: 0 0 20px; padding-bottom: 10px; border-bottom: 1px solid #444; }
    .left-menu a { display: block; color: #fff; text-decoration: none; padding: 10px; margin: 8px 0; border-radius: 4px; }
    .left-menu a.active, .left-menu a:hover { background: #3498db; }
    .right-content { background: #fff; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel { display: none; }
    .panel.show { display: block; }
    .form-item { margin: 20px 0; max-width: 400px; }
    .form-item label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
    .form-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
    .form-item input:focus { border-color: #3498db; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; background: #3498db; color: white; cursor: pointer; width: 100%; max-width: 400px; }
    .btn-sm { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin: 0 3px; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-reset { background: #f39c12; color: white; }
    .btn-toggle { background: #95a5a6; color: white; }
    .stat-card { display: inline-block; width: 180px; padding: 15px; margin: 0 10px 10px 0; background: #f8f9fa; border-radius: 6px; text-align: center; }
    .stat-card .num { font-size: 22px; font-weight: bold; color: #2c3e50; margin: 5px 0; }
    .table-simple { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .table-simple th, .table-simple td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    .table-simple th { background: #f8f9fa; }
    .empty-tip { color: #999; padding: 30px 0; text-align: center; }
    .status-on { color: #27ae60; font-weight: 500; }
    .status-off { color: #e74c3c; font-weight: 500; }
    /* å°å±é€‚é… */
    @media (max-width: 768px) { .admin-box { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¤´éƒ¨ï¼šç™»å½•å+é€€å‡º -->
  <div class="page-header" style="padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
    <h2>ç®¡ç†å‘˜åå° - <span id="adminName">ak</span></h2>
    <button class="btn-danger" onclick="logout()" style="width: auto; padding: 6px 12px;">å®‰å…¨é€€å‡º</button>
  </div>

  <!-- æ ¸å¿ƒå¸ƒå±€ï¼šå·¦ä¾§èœå•+å³ä¾§å†…å®¹ï¼ˆç‚¹å‡»å¿…åˆ‡æ¢ï¼Œæ— å¡é¡¿ï¼‰ -->
  <div class="admin-box">
    <div class="left-menu">
      <h3>ç®¡ç†èœå•</h3>
      <a href="javascript:;" class="active" onclick="showPanel('panel1')">æ•°æ®æ¦‚è§ˆ</a>
      <a href="javascript:;" onclick="showPanel('panel2')">ä»£ç†æ•°æ®</a>
      <a href="javascript:;" onclick="showPanel('panel3')">æ·»åŠ ä»£ç†</a>
      <a href="javascript:;" onclick="showPanel('panel4')">æ–‡ä»¶ç®¡ç†</a>
      <a href="javascript:;" onclick="showPanel('panel5')">ç³»ç»Ÿæ—¥å¿—</a>
    </div>

    <div class="right-content">
      <!-- 1. æ•°æ®æ¦‚è§ˆï¼šå®æ—¶ç»Ÿè®¡ï¼Œæ“ä½œåè‡ªåŠ¨æ›´æ–° -->
      <div class="panel show" id="panel1">
        <h2>æ•°æ®æ¦‚è§ˆ</h2>
        <div class="stat-card"><div class="num" id="t1">0</div><div>æ€»ä»£ç†æ•°</div></div>
        <div class="stat-card"><div class="num" id="t2">0</div><div>å¯ç”¨ä»£ç†æ•°</div></div>
        <div class="stat-card"><div class="num" id="t3">0</div><div>æ€»æ–‡ä»¶æ•°</div></div>
        <div class="stat-card"><div class="num" id="t4">0</div><div>æ“ä½œæ—¥å¿—æ•°</div></div>
      </div>

      <!-- 2. ä»£ç†æ•°æ®ï¼šç¦ç”¨/å¯ç”¨/é‡ç½®/åˆ é™¤ å…¨å¯ç”¨ -->
      <div class="panel" id="panel2">
        <h2>ä»£ç†æ•°æ®</h2>
        <input type="text" placeholder="æœç´¢ç”¨æˆ·å" oninput="filterProxy()" style="padding: 8px; width: 250px; margin-bottom: 10px;">
        <table class="table-simple" id="proxyTable">
          <thead><tr><th>åºå·</th><th>ç”¨æˆ·å</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
          <tbody><tr><td colspan="4" class="empty-tip">æš‚æ— ä»£ç†æ•°æ®</td></tr></tbody>
        </table>
      </div>

      <!-- 3. æ·»åŠ ä»£ç†ï¼šè¾“å…¥æ¡†å¿…å‡ºï¼Œæäº¤å¿…æˆåŠŸ -->
      <div class="panel" id="panel3">
        <h2>æ·»åŠ ä»£ç†è´¦å·</h2>
        <div class="form-item">
          <label>ä»£ç†ç”¨æˆ·å <span style="color: red;">*</span></label>
          <input type="text" id="proxyName" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·åï¼Œå¦‚daily">
        </div>
        <div class="form-item">
          <label>ä»£ç†å¯†ç  <span style="color: red;">*</span></label>
          <input type="password" id="proxyPwd" placeholder="è¯·è¾“å…¥ç™»å½•å¯†ç ">
        </div>
        <button class="btn" onclick="addProxy()">ç¡®è®¤æ·»åŠ ä»£ç†</button>
      </div>

      <!-- 4. æ–‡ä»¶ç®¡ç†ï¼šæŸ¥çœ‹/åˆ é™¤ æ–‡ä»¶å…¨å¯ç”¨ -->
      <div class="panel" id="panel4">
        <h2>æ–‡ä»¶ç®¡ç†</h2>
        <input type="text" placeholder="æœç´¢ä»£ç†/æ–‡ä»¶å" oninput="filterFile()" style="padding: 8px; width: 250px; margin-bottom: 10px;">
        <table class="table-simple" id="fileTable">
          <thead><tr><th>åºå·</th><th>æ‰€å±ä»£ç†</th><th>æ–‡ä»¶å</th><th>æ“ä½œ</th></tr></thead>
          <tbody><tr><td colspan="4" class="empty-tip">æš‚æ— æ–‡ä»¶æ•°æ®</td></tr></tbody>
        </table>
      </div>

      <!-- 5. ç³»ç»Ÿæ—¥å¿—ï¼šæ‰€æœ‰æ“ä½œè‡ªåŠ¨è®°å½•ï¼Œä¸é—æ¼ -->
      <div class="panel" id="panel5">
        <h2>ç³»ç»Ÿæ—¥å¿—</h2>
        <table class="table-simple" id="logTable">
          <thead><tr><th>åºå·</th><th>æ—¶é—´</th><th>æ“ä½œäºº</th><th>æ“ä½œ</th></tr></thead>
          <tbody><tr><td colspan="4" class="empty-tip">æš‚æ— æ“ä½œæ—¥å¿—</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="common.js"></script>
  <script>
    // 1. æƒé™éªŒè¯ï¼šéç®¡ç†å‘˜ç›´æ¥è·³ç™»å½•é¡µ
    const currentUser = checkAuth('admin');
    if (!currentUser) location.href = 'index.html';
    document.getElementById('adminName').innerText = currentUser.username;

    // 2. åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ˆåˆ·æ–°ä¸ä¸¢å¤±ï¼‰
    let sysUser = getLocalData('systemUsers') || [CONFIG.SUPER_ADMIN];
    let sysFile = getLocalData('allFiles') || {};
    let sysLog = getLocalData('systemLogs') || [];

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰æ•°æ®
    window.onload = () => { initAll(); };

    // ğŸ”´ æ ¸å¿ƒï¼šèœå•åˆ‡æ¢ï¼ˆ100%ç¨³å®šï¼Œç‚¹å‡»å¿…æ˜¾ï¼‰
    function showPanel(panelId) {
      document.querySelectorAll('.left-menu a').forEach(a => a.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
      event.target.classList.add('active');
      document.getElementById(panelId).classList.add('show');
    }

    // ğŸ”´ ä¿®å¤1ï¼šæ·»åŠ ä»£ç†ï¼ˆéªŒè¯+æç¤º+è‡ªåŠ¨è·³è½¬ï¼Œæ— æŠ¥é”™ï¼‰
    function addProxy() {
      const name = document.getElementById('proxyName').value.trim();
      const pwd = document.getElementById('proxyPwd').value.trim();
      if (!name) { alert('è¯·è¾“å…¥ä»£ç†ç”¨æˆ·åï¼'); return; }
      if (!pwd) { alert('è¯·è¾“å…¥ä»£ç†å¯†ç ï¼'); return; }
      if (sysUser.some(u => u.username === name)) { alert('è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼'); return; }
      // æ·»åŠ æ–°ä»£ç†å¹¶åˆå§‹åŒ–æ–‡ä»¶ç›®å½•
      sysUser.push({ username: name, password: pwd, role: 'proxy', status: 'active', lastLogin: 'æš‚æ— ç™»å½•' });
      sysFile[name] = [];
      // ä¿å­˜æ•°æ®+è®°å½•æ—¥å¿—+åˆ·æ–°é¡µé¢
      saveAllData();
      addLog(`æ·»åŠ ä»£ç†ã€${name}ã€‘`);
      initAll();
      // é‡ç½®è¡¨å•+æç¤º+è‡ªåŠ¨åˆ‡åˆ°ä»£ç†æ•°æ®æŸ¥çœ‹
      document.getElementById('proxyName').value = '';
      document.getElementById('proxyPwd').value = '';
      alert(`ä»£ç†ã€${name}ã€‘æ·»åŠ æˆåŠŸï¼`);
      showPanel('panel2');
    }

    // ğŸ”´ ä¿®å¤2ï¼šç¦ç”¨/å¯ç”¨ä»£ç†ï¼ˆç‚¹å‡»å¿…ååº”ï¼ŒçŠ¶æ€å®æ—¶å˜ï¼Œå¸¦æç¤ºï¼‰
    function toggleProxy(name) {
      const proxy = sysUser.find(u => u.username === name);
      if (!proxy) return;
      const oldStatus = proxy.status;
      const newStatus = oldStatus === 'active' ? 'disabled' : 'active';
      // åˆ‡æ¢çŠ¶æ€
      sysUser = sysUser.map(u => u.username === name ? { ...u, status: newStatus } : u);
      saveAllData();
      addLog(`${oldStatus === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨'}ä»£ç†ã€${name}ã€‘`);
      initAll();
      alert(`ä»£ç†ã€${name}ã€‘å·²${oldStatus === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨'}ï¼`);
    }

    // ğŸ”´ ä¿®å¤3ï¼šé‡ç½®ä»£ç†å¯†ç ï¼ˆéªŒè¯+æç¤º+æ—¥å¿—ï¼Œæ— æŠ¥é”™ï¼‰
    function resetPwd(name) {
      const newPwd = prompt(`è¯·è¾“å…¥ä»£ç†ã€${name}ã€‘çš„æ–°å¯†ç ï¼š`, '123456');
      if (newPwd === null) return; // å–æ¶ˆè¾“å…¥ä¸æ‰§è¡Œ
      const pwd = newPwd.trim();
      if (!pwd) { alert('å¯†ç ä¸èƒ½ä¸ºç©ºï¼'); return; }
      // ä¿®æ”¹å¯†ç 
      sysUser = sysUser.map(u => u.username === name ? { ...u, password: pwd } : u);
      saveAllData();
      addLog(`é‡ç½®ä»£ç†ã€${name}ã€‘å¯†ç `);
      initAll();
      alert(`ä»£ç†ã€${name}ã€‘å¯†ç é‡ç½®æˆåŠŸï¼æ–°å¯†ç ï¼š${pwd}`);
    }

    // ğŸ”´ ä¿®å¤4ï¼šåˆ é™¤ä»£ç†ï¼ˆäºŒæ¬¡ç¡®è®¤+åˆ é™¤æ–‡ä»¶+æ—¥å¿—ï¼Œé˜²è¯¯åˆ ï¼‰
    function delProxy(name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ä»£ç†ã€${name}ã€‘å—ï¼Ÿ\nåˆ é™¤åå°†åŒæ­¥æ¸…é™¤è¯¥ä»£ç†çš„æ‰€æœ‰æ–‡ä»¶æ•°æ®ï¼`)) return;
      sysUser = sysUser.filter(u => u.username !== name);
      delete sysFile[name]; // åŒæ­¥åˆ é™¤ä»£ç†æ–‡ä»¶
      saveAllData();
      addLog(`åˆ é™¤ä»£ç†ã€${name}ã€‘åŠæ‰€æœ‰æ–‡ä»¶`);
      initAll();
      alert(`ä»£ç†ã€${name}ã€‘å·²åˆ é™¤ï¼`);
    }

    // ğŸ”´ ä¿®å¤5ï¼šåˆ é™¤æ–‡ä»¶ï¼ˆäºŒæ¬¡ç¡®è®¤+æ—¥å¿—+åˆ·æ–°ï¼Œæ— æŠ¥é”™ï¼‰
    function delFile(agentName, fileId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ–‡ä»¶å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
      sysFile[agentName] = sysFile[agentName].filter(f => f.id !== fileId);
      saveAllData();
      addLog(`åˆ é™¤ä»£ç†ã€${agentName}ã€‘çš„æ–‡ä»¶ï¼ˆIDï¼š${fileId}ï¼‰`);
      initAll();
      alert('æ–‡ä»¶å·²æˆåŠŸåˆ é™¤ï¼');
    }

    // ğŸ“Š åˆå§‹åŒ–æ‰€æœ‰æ•°æ®ï¼šç»Ÿè®¡+è¡¨æ ¼æ¸²æŸ“ï¼ˆä¸€é”®åˆ·æ–°ï¼‰
    function initAll() {
      // æ›´æ–°æ•°æ®æ¦‚è§ˆç»Ÿè®¡
      const allProxy = sysUser.filter(u => u.role === 'proxy');
      const activeProxy = allProxy.filter(u => u.status === 'active').length;
      let totalFile = 0;
      Object.values(sysFile).forEach(files => totalFile += files.length);
      document.getElementById('t1').innerText = allProxy.length;
      document.getElementById('t2').innerText = activeProxy;
      document.getElementById('t3').innerText = totalFile;
      document.getElementById('t4').innerText = sysLog.length;

      // æ¸²æŸ“ä»£ç†è¡¨æ ¼
      renderProxyTable();
      // æ¸²æŸ“æ–‡ä»¶è¡¨æ ¼
      renderFileTable();
      // æ¸²æŸ“ç³»ç»Ÿæ—¥å¿—è¡¨æ ¼
      renderLogTable();
    }

    // ğŸ“‹ æ¸²æŸ“ä»£ç†è¡¨æ ¼ï¼ˆå¸¦çŠ¶æ€åŒºåˆ†ï¼ŒæŒ‰é’®æ ·å¼ä¼˜åŒ–ï¼‰
    function renderProxyTable() {
      const allProxy = sysUser.filter(u => u.role === 'proxy');
      const tb = document.querySelector('#proxyTable tbody');
      if (allProxy.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" class="empty-tip">æš‚æ— ä»£ç†æ•°æ®ï¼Œå…ˆæ·»åŠ ä»£ç†å§~</td></tr>';
        return;
      }
      tb.innerHTML = allProxy.map((u, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${u.username}</td>
          <td class="${u.status==='active'?'status-on':'status-off'}">${u.status==='active'?'å·²å¯ç”¨':'å·²ç¦ç”¨'}</td>
          <td>
            <button class="btn-sm btn-toggle" onclick="toggleProxy('${u.username}')">${u.status==='active'?'ç¦ç”¨':'å¯ç”¨'}</button>
            <button class="btn-sm btn-reset" onclick="resetPwd('${u.username}')">é‡ç½®å¯†ç </button>
            <button class="btn-sm btn-danger" onclick="delProxy('${u.username}')">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }

    // ğŸ“‹ æ¸²æŸ“æ–‡ä»¶è¡¨æ ¼ï¼ˆæŸ¥çœ‹+åˆ é™¤ï¼Œé“¾æ¥æ­£å¸¸æ‰“å¼€ï¼‰
    function renderFileTable() {
      let allFileList = [];
      Object.keys(sysFile).forEach(agent => {
        sysFile[agent].forEach(file => allFileList.push({ agent, ...file }));
      });
      const tb = document.querySelector('#fileTable tbody');
      if (allFileList.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" class="empty-tip">æš‚æ— æ–‡ä»¶æ•°æ®ï¼Œä»£ç†ä¸Šä¼ åå¯æŸ¥çœ‹~</td></tr>';
        return;
      }
      tb.innerHTML = allFileList.map((f, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${f.agent}</td>
          <td>${f.name}</td>
          <td>
            <a href="${f.url || '#'}" target="_blank" style="color:#3498db; text-decoration: none; margin-right: 8px;">æŸ¥çœ‹</a>
            <a href="javascript:;" onclick="delFile('${f.agent}', ${f.id})" style="color:red; text-decoration: none;">åˆ é™¤</a>
          </td>
        </tr>
      `).join('');
    }

    // ğŸ“‹ æ¸²æŸ“ç³»ç»Ÿæ—¥å¿—è¡¨æ ¼ï¼ˆå€’åºæ˜¾ç¤ºï¼Œæœ€æ–°æ“ä½œåœ¨æœ€å‰ï¼‰
    function renderLogTable() {
      const tb = document.querySelector('#logTable tbody');
      if (sysLog.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" class="empty-tip">æš‚æ— æ“ä½œæ—¥å¿—ï¼Œæ‰§è¡Œæ“ä½œåè‡ªåŠ¨è®°å½•~</td></tr>';
        return;
      }
      // å€’åºæ¸²æŸ“ï¼Œæœ€æ–°æ“ä½œåœ¨æœ€ä¸Šé¢
      tb.innerHTML = sysLog.reverse().map((l, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${l.time}</td>
          <td>${l.operator}</td>
          <td>${l.type}</td>
        </tr>
      `).join('');
    }

    // ğŸ” ç­›é€‰ä»£ç†ï¼ˆå®æ—¶è¾“å…¥ï¼Œç²¾å‡†ç­›é€‰ï¼‰
    function filterProxy() {
      const keyword = document.querySelector('#panel2 input').value.toLowerCase().trim();
      document.querySelectorAll('#proxyTable tbody tr').forEach(row => {
        const uname = row.cells[1].textContent.toLowerCase();
        row.style.display = uname.includes(keyword) ? '' : 'none';
      });
    }

    // ğŸ” ç­›é€‰æ–‡ä»¶ï¼ˆä»£ç†å/æ–‡ä»¶åï¼ŒåŒé‡ç­›é€‰ï¼‰
    function filterFile() {
      const keyword = document.querySelector('#panel4 input').value.toLowerCase().trim();
      document.querySelectorAll('#fileTable tbody tr').forEach(row => {
        const agent = row.cells[1].textContent.toLowerCase();
        const fname = row.cells[2].textContent.toLowerCase();
        row.style.display = agent.includes(keyword) || fname.includes(keyword) ? '' : 'none';
      });
    }

    // ğŸ’¾ ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç»Ÿä¸€æ–¹æ³•ï¼Œé¿å…é—æ¼ï¼‰
    function saveAllData() {
      setLocalData('systemUsers', sysUser);
      setLocalData('allFiles', sysFile);
      setLocalData('systemLogs', sysLog);
    }

    // ğŸ“ æ·»åŠ ç³»ç»Ÿæ—¥å¿—ï¼ˆç»Ÿä¸€æ ¼å¼ï¼Œè‡ªåŠ¨è®°å½•æ—¶é—´/æ“ä½œäººï¼‰
    function addLog(operType) {
      sysLog.push({
        time: new Date().toLocaleString(),
        operator: currentUser.username,
        type: operType
      });
      saveAllData();
    }
  </script>
</body>
</html>
