<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¶…çº§ç®¡ç†å‘˜åå°</title>
  <!-- å¼•å…¥å…¬å…±æ ·å¼ -->
  <link rel="stylesheet" href="common.css">
  <style>
    /* ä»…åå°é¡µä¸“å±æ ·å¼ï¼ˆæ¯”å¦‚ä¸¤æ å¸ƒå±€ï¼‰ */
    .admin-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    .user-list, .agent-file-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .agent-filter { margin-bottom: 20px; }
    @media (max-width: 768px) { .admin-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- ä»…åå°é¡µç»“æ„ -->
  <div class="page-header">
    <h1>è¶…çº§ç®¡ç†å‘˜åå° - <span id="adminName"></span></h1>
    <button class="btn-danger" onclick="logout()">å®‰å…¨é€€å‡º</button>
  </div>

  <div class="admin-container">
    <!-- ä»£ç†è´¦å·ç®¡ç† -->
    <div class="card">
      <h3>ä»£ç†è´¦å·ç®¡ç†</h3>
      <input type="text" id="newUser" placeholder="ä»£ç†ç”¨æˆ·å" required>
      <input type="password" id="newPwd" placeholder="ä»£ç†å¯†ç " required>
      <button class="btn" onclick="addProxy()">æ·»åŠ ä»£ç†</button>
      <p class="tip">âœ… æ–°å¢é»˜è®¤ä¸ºä»£ç†æƒé™</p>
      <div class="user-list" id="userList"></div>
    </div>

    <!-- ä»£ç†æ–‡ä»¶ç®¡ç† -->
    <div class="card">
      <h3>ä»£ç†æ–‡ä»¶ç®¡ç†</h3>
      <input type="text" class="agent-filter" id="fileFilter" placeholder="è¾“å…¥ä»£ç†åç­›é€‰" oninput="filterFiles()">
      <div class="agent-file-list" id="fileList"></div>
    </div>
  </div>

  <!-- å¼•å…¥å…¬å…±JS -->
  <script src="common.js"></script>
  <script>
    // æƒé™éªŒè¯ï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®
    const currentUser = checkAuth('admin');
    if (!currentUser) return;
    document.getElementById('adminName').innerText = currentUser.username;

    // åˆå§‹åŒ–æ•°æ®ï¼ˆç”¨æˆ·+æ–‡ä»¶ï¼‰
    let systemUsers = getLocalData('systemUsers');
    let allFiles = getLocalData('allFiles') || {};
    // ä»…æ˜¾ç¤ºä»£ç†ç”¨æˆ·
    const proxyUsers = systemUsers.filter(u => u.role === 'proxy');

    // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“æ•°æ®
    window.onload = function() {
      renderUserList();
      renderFileList();
    }

    // 1. ä»£ç†è´¦å·ç®¡ç†ï¼šæ·»åŠ ä»£ç†
    function addProxy() {
      const username = document.getElementById('newUser').value.trim();
      const password = document.getElementById('newPwd').value.trim();
      if (systemUsers.some(u => u.username === username)) {
        alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼');
        return;
      }
      // æ·»åŠ ä»£ç†+åˆå§‹åŒ–æ–‡ä»¶ç›®å½•
      systemUsers.push({ username, password, role: 'proxy' });
      allFiles[username] = allFiles[username] || [];
      // ä¿å­˜æ•°æ®å¹¶åˆ·æ–°
      setLocalData('systemUsers', systemUsers);
      setLocalData('allFiles', allFiles);
      alert(`ä»£ç†ã€${username}ã€‘æ·»åŠ æˆåŠŸï¼`);
      document.getElementById('newUser').value = '';
      document.getElementById('newPwd').value = '';
      renderUserList();
    }

    // 2. ä»£ç†è´¦å·ç®¡ç†ï¼šåˆ é™¤ä»£ç†
    function delProxy(username) {
      if (!confirm(`ç¡®å®šåˆ é™¤ä»£ç†ã€${username}ã€‘åŠæ‰€æœ‰æ–‡ä»¶ï¼Ÿ`)) return;
      systemUsers = systemUsers.filter(u => u.username !== username);
      delete allFiles[username];
      setLocalData('systemUsers', systemUsers);
      setLocalData('allFiles', allFiles);
      renderUserList();
      renderFileList();
    }

    // 3. æ¸²æŸ“ä»£ç†è´¦å·åˆ—è¡¨
    function renderUserList() {
      const userList = document.getElementById('userList');
      const proxies = systemUsers.filter(u => u.role === 'proxy');
      if (proxies.length === 0) {
        userList.innerHTML = '<p class="empty-tip">æš‚æ— ä»£ç†è´¦å·</p>';
        return;
      }
      userList.innerHTML = proxies.map(u => `
        <div class="item">
          <span>${u.username}</span>
          <button class="btn-danger" onclick="delProxy('${u.username}')">åˆ é™¤</button>
        </div>
      `).join('');
    }

    // 4. æ¸²æŸ“ä»£ç†æ–‡ä»¶åˆ—è¡¨
    function renderFileList() {
      const fileList = document.getElementById('fileList');
      const proxies = systemUsers.filter(u => u.role === 'proxy');
      const hasFileAgents = proxies.filter(p => allFiles[p.username] && allFiles[p.username].length > 0);
      
      if (proxies.length === 0) {
        fileList.innerHTML = '<p class="empty-tip">æš‚æ— ä»£ç†è´¦å·</p>';
        return;
      }
      if (hasFileAgents.length === 0) {
        fileList.innerHTML = '<p class="empty-tip">æ‰€æœ‰ä»£ç†æš‚æ— æ–‡ä»¶</p>';
        return;
      }
      fileList.innerHTML = hasFileAgents.map(p => {
        const files = allFiles[p.username];
        return `
          <div class="agent-folder" data-agent="${p.username}">
            <h4>ğŸ“ ä»£ç†ã€${p.username}ã€‘(${files.length}ä¸ªæ–‡ä»¶)</h4>
            ${files.map(f => `
              <div class="item">
                <div>
                  <span>${f.name}</span>
                  <small>${f.size} | ${f.time}</small>
                </div>
                <div>
                  <a href="${f.url}" target="_blank" style="color: #3498db; text-decoration: none; margin-right: 10px;">æ‰“å¼€</a>
                  <button class="btn-danger" onclick="delFile('${p.username}', ${f.id})">åˆ é™¤</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    // 5. åˆ é™¤ä»£ç†æ–‡ä»¶
    function delFile(agentName, fileId) {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ä»¶ï¼Ÿ')) return;
      allFiles[agentName] = allFiles[agentName].filter(f => f.id !== fileId);
      setLocalData('allFiles', allFiles);
      renderFileList();
    }

    // 6. ç­›é€‰ä»£ç†æ–‡ä»¶
    function filterFiles() {
      const filter = document.getElementById('fileFilter').value.trim().toLowerCase();
      document.querySelectorAll('.agent-folder').forEach(f => {
        f.style.display = f.dataset.agent.toLowerCase().includes(filter) ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>
