<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…çº§ç®¡ç†å‘˜åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { background: #f5f7fa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: #2c3e50; color: white; padding: 15px 30px; border-radius: 8px; margin-bottom: 30px; width: 100%; max-width: 1200px; }
        .admin-header button { background: #e74c3c; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .admin-header button:hover { background: #c0392b; }
        .admin-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; width: 100%; max-width: 1200px; }
        .admin-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 100%; }
        .admin-card h2 { color: #34495e; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; font-size: 20px; }
        .btn { background: #3498db; border: none; color: white; padding: 10px 25px; border-radius: 4px; cursor: pointer; transition: background 0.3s; margin-top: 15px; font-size: 16px; }
        .btn:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; padding: 6px 12px; font-size: 14px; border: none; color: white; border-radius: 4px; cursor: pointer; }
        .btn-danger:hover { background: #c0392b; }
        .tip { color: #7f8c8d; font-size: 14px; margin-top: 15px; }
        .user-list, .agent-file-list { margin-top: 20px; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .user-item, .agent-file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; }
        .user-item div, .agent-file-item div { display: flex; flex-direction: column; }
        .user-item small, .agent-file-item small { color: #7f8c8d; font-size: 12px; margin-top: 5px; }
        .agent-file-item a { color: #3498db; text-decoration: none; margin-right: 10px; }
        .agent-file-item a:hover { text-decoration: underline; }
        .user-role { color: #27ae60; font-size: 14px; font-weight: 500; }
        .role-proxy { color: #f39c12; }
        .empty-tip { color: #7f8c8d; text-align: center; padding: 30px 0; font-size: 14px; }
        .agent-filter { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; font-size: 14px; outline: none; }
        .agent-filter:focus { border-color: #3498db; }
        .agent-folder-title { color: #2c3e50; font-weight: 600; margin: 15px 0 10px 0; font-size: 15px; }
        .user-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .user-form input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        @media (max-width: 768px) { .admin-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>è¶…çº§ç®¡ç†å‘˜ç®¡ç†åå° - ak</h1>
        <button id="logoutBtn">å®‰å…¨é€€å‡º</button>
    </div>

    <div class="admin-container">
        <!-- 1. ä»£ç†è´¦å·ç®¡ç† -->
        <div class="admin-card">
            <h2>ä»£ç†è´¦å·ç®¡ç†</h2>
            <form id="addUserForm" class="user-form">
                <input type="text" id="newUsername" placeholder="ä»£ç†ç”¨æˆ·å" required>
                <input type="password" id="newPassword" placeholder="ä»£ç†å¯†ç " required>
                <select id="newRole" required style="display: none;">
                    <option value="proxy" selected>ä»£ç†</option>
                </select>
                <button type="submit" class="btn">æ·»åŠ ä»£ç†</button>
                <p class="tip">âœ… æ–°å¢é»˜è®¤ä¸ºä»£ç†ï¼Œæ— ç”¨æˆ·ç®¡ç†æƒé™</p>
            </form>
            <div class="user-list">
                <h3>ä»£ç†è´¦å·åˆ—è¡¨</h3>
                <div id="userListContainer"></div>
            </div>
        </div>

        <!-- 2. ä»£ç†æ–‡ä»¶ç®¡ç† -->
        <div class="admin-card">
            <h2>ä»£ç†æ–‡ä»¶ç®¡ç†</h2>
            <input type="text" id="agentFileFilter" class="agent-filter" placeholder="è¾“å…¥ä»£ç†ç”¨æˆ·åç­›é€‰æ–‡ä»¶...">
            <div class="agent-file-list">
                <div id="agentFileListContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const LOGIN_PAGE = 'index.html';
        const SUPER_ADMIN = { username: 'ak', password: '2026', role: 'admin' };
        let currentUser = JSON.parse(localStorage.getItem('currentLoginUser'));
        let systemUsers = JSON.parse(localStorage.getItem('systemUsers')) || [SUPER_ADMIN];
        let allFiles = JSON.parse(localStorage.getItem('allFiles')) || {};

        // æƒé™éªŒè¯ï¼šéakç®¡ç†å‘˜ç¦æ­¢è®¿é—®
        window.onload = function() {
            if (!currentUser || currentUser.role !== 'admin' || currentUser.username !== 'ak') {
                alert('æ— è¶…çº§ç®¡ç†å‘˜æƒé™ï¼Œç¦æ­¢è®¿é—®ï¼');
                window.location.href = LOGIN_PAGE;
                return;
            }
            renderUserList();
            renderAllAgentFiles();
            document.getElementById('agentFileFilter').addEventListener('input', filterAgentFiles);
        }

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šé€€å‡ºè¶…çº§ç®¡ç†å‘˜åå°å—ï¼Ÿ')) {
                localStorage.removeItem('currentLoginUser');
                window.location.href = LOGIN_PAGE;
            }
        });

        // ---------------------- ä»£ç†è´¦å·ç®¡ç† ----------------------
        const addUserForm = document.getElementById('addUserForm');
        addUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            if (systemUsers.some(user => user.username === username)) {
                alert('è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼');
                return;
            }
            if (!allFiles[username]) allFiles[username] = [];
            systemUsers.push({ username, password, role: 'proxy' });
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            localStorage.setItem('allFiles', JSON.stringify(allFiles));
            alert(`ä»£ç†è´¦å·ã€${username}ã€‘æ·»åŠ æˆåŠŸï¼`);
            addUserForm.reset();
            renderUserList();
            renderAllAgentFiles();
        });

        function renderUserList() {
            const container = document.getElementById('userListContainer');
            const proxyUsers = systemUsers.filter(user => user.role === 'proxy');
            if (proxyUsers.length === 0) {
                container.innerHTML = '<p class="empty-tip">æš‚æ— æ·»åŠ ä»£ç†è´¦å·</p>';
                return;
            }
            let userHtml = '';
            proxyUsers.forEach(user => {
                userHtml += `
                    <div class="user-item">
                        <div>
                            <span>${user.username}</span>
                            <small class="user-role role-proxy">æƒé™ï¼šä»£ç†</small>
                        </div>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">åˆ é™¤</button>
                    </div>
                `;
            });
            container.innerHTML = userHtml;
        }

        window.deleteUser = function(username) {
            if (confirm(`ç¡®å®šåˆ é™¤ä»£ç†ã€${username}ã€‘å—ï¼Ÿå°†åŒæ—¶åˆ é™¤è¯¥ä»£ç†çš„æ‰€æœ‰æ–‡ä»¶ï¼`)) {
                systemUsers = systemUsers.filter(user => user.username !== username);
                delete allFiles[username];
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                localStorage.setItem('allFiles', JSON.stringify(allFiles));
                renderUserList();
                renderAllAgentFiles();
            }
        };

        // ---------------------- ä»£ç†æ–‡ä»¶ç®¡ç† ----------------------
        function renderAllAgentFiles() {
            const container = document.getElementById('agentFileListContainer');
            const proxyUsers = systemUsers.filter(user => user.role === 'proxy');
            const agentWithFiles = proxyUsers.filter(agent => allFiles[agent.username] && allFiles[agent.username].length > 0);
            
            if (proxyUsers.length === 0) {
                container.innerHTML = '<p class="empty-tip">æš‚æ— æ·»åŠ ä»£ç†è´¦å·</p>';
                return;
            }
            if (agentWithFiles.length === 0) {
                container.innerHTML = '<p class="empty-tip">æ‰€æœ‰ä»£ç†æš‚æ— ä¸Šä¼ æ–‡ä»¶</p>';
                return;
            }
            let agentFileHtml = '';
            agentWithFiles.forEach(agent => {
                const agentFiles = allFiles[agent.username];
                agentFileHtml += `<div class="agent-folder" data-agent="${agent.username}">`;
                agentFileHtml += `<p class="agent-folder-title">ğŸ“ ä»£ç†ã€${agent.username}ã€‘- å…±${agentFiles.length}ä¸ªæ–‡ä»¶</p>`;
                agentFiles.forEach(file => {
                    agentFileHtml += `
                        <div class="agent-file-item">
                            <div>
                                <span>${file.name}</span>
                                <small>${formatFileSize(file.size)} | ä¸Šä¼ æ—¶é—´ï¼š${file.time}</small>
                            </div>
                            <div>
                                <a href="${file.url}" target="_blank">æ‰“å¼€/ä¸‹è½½</a>
                                <button class="btn btn-danger" onclick="deleteAgentFile('${agent.username}', ${file.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                agentFileHtml += '</div>';
            });
            container.innerHTML = agentFileHtml;
        }

        function filterAgentFiles() {
            const filterText = document.getElementById('agentFileFilter').value.trim().toLowerCase();
            const agentFolders = document.querySelectorAll('.agent-folder');
            agentFolders.forEach(folder => {
                const agentName = folder.dataset.agent.toLowerCase();
                folder.style.display = agentName.includes(filterText) ? 'block' : 'none';
            });
        }

        window.deleteAgentFile = function(agentName, fileId) {
            if (confirm(`ç¡®å®šåˆ é™¤ä»£ç†ã€${agentName}ã€‘çš„è¯¥æ–‡ä»¶å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼`)) {
                allFiles[agentName] = allFiles[agentName].filter(file => file.id !== fileId);
                localStorage.setItem('allFiles', JSON.stringify(allFiles));
                renderAllAgentFiles();
            }
        };

        // ---------------------- é€šç”¨æ–¹æ³• ----------------------
        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB';
            return (size / (1024 * 1024)).toFixed(2) + ' MB';
        }
    </script>
</body>
</html>
